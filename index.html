<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DDSP Neural Cello - embracingearth.space</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* embracingearth.space - Premium DDSP Neural Cello Styles */
        .glass-dark {
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(168, 85, 247, 0.2);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #9333ea 0%, #3b82f6 100%);
            transition: all 0.2s;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #7c3aed 0%, #2563eb 100%);
            transform: scale(1.05);
        }
        
        .audio-waveform {
            background: linear-gradient(90deg, #9333ea, #3b82f6);
            height: 80px;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }
        
        .audio-waveform::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: wave 2s infinite;
        }
        
        @keyframes wave {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .loading-spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid #9333ea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .quality-option {
            transition: all 0.2s;
        }
        
        .quality-option:hover {
            transform: scale(1.02);
        }
        
        .quality-option.selected {
            background: linear-gradient(135deg, #9333ea 0%, #3b82f6 100%);
            border-color: #9333ea;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        
        .loading-animation {
            animation: pulse 1.5s ease-in-out infinite;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 text-white">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-2 bg-gradient-to-r from-purple-400 to-blue-400 bg-clip-text text-transparent">
                DDSP Neural Cello
            </h1>
            <p class="text-gray-300">embracingearth.space - Premium AI Audio Synthesis</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Left Column -->
            <div class="space-y-6">
                <!-- MIDI Upload -->
                <div class="glass-dark rounded-xl p-6">
                    <h2 class="text-xl font-semibold mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        MIDI File Upload
                    </h2>
                    
                    <div id="upload-area" class="border-2 border-dashed border-purple-400 rounded-lg p-8 text-center cursor-pointer hover:border-purple-300 transition-colors">
                        <svg class="w-12 h-12 mx-auto mb-4 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        <p class="text-lg mb-2">Drop your MIDI file here or click to browse</p>
                        <p class="text-sm text-gray-400">Supports .mid and .midi files</p>
                    </div>
                    
                    <input type="file" id="file-input" accept=".mid,.midi" class="hidden">
                    
                    <div id="file-info" class="mt-4 hidden">
                        <div class="flex items-center p-3 bg-purple-900/30 rounded-lg">
                            <svg class="w-5 h-5 mr-3 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                            </svg>
                            <span id="file-name" class="text-sm"></span>
                        </div>
                    </div>
                </div>

                <!-- Audio Quality -->
                <div class="glass-dark rounded-xl p-6">
                    <h2 class="text-xl font-semibold mb-4">Audio Quality</h2>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="quality-option p-3 rounded-lg border border-gray-600 cursor-pointer" data-quality="draft">
                            <div class="font-semibold">Draft</div>
                            <div class="text-sm text-gray-400">Fast processing, lower quality</div>
                        </div>
                        <div class="quality-option p-3 rounded-lg border border-gray-600 cursor-pointer" data-quality="standard">
                            <div class="font-semibold">Standard</div>
                            <div class="text-sm text-gray-400">Balanced quality/speed</div>
                        </div>
                        <div class="quality-option p-3 rounded-lg border border-gray-600 cursor-pointer selected" data-quality="professional">
                            <div class="font-semibold">Professional</div>
                            <div class="text-sm text-gray-400">High quality, slower</div>
                        </div>
                        <div class="quality-option p-3 rounded-lg border border-gray-600 cursor-pointer" data-quality="mastering">
                            <div class="font-semibold">Mastering</div>
                            <div class="text-sm text-gray-400">Maximum quality, slowest</div>
                        </div>
                    </div>
                </div>

                <!-- Settings Button -->
                <div class="glass-dark rounded-xl p-6">
                    <h2 class="text-xl font-semibold mb-4">Settings</h2>
                    <button id="settings-btn" class="btn-primary px-6 py-3 rounded-lg font-semibold w-full">
                        Open Settings
                    </button>
                    <div id="settings-panel" class="mt-4 hidden">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Sample Rate</label>
                                <select class="w-full p-2 bg-gray-800 border border-gray-600 rounded-lg">
                                    <option value="44100">44.1 kHz</option>
                                    <option value="48000" selected>48 kHz (Professional)</option>
                                    <option value="96000">96 kHz</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Bit Depth</label>
                                <select class="w-full p-2 bg-gray-800 border border-gray-600 rounded-lg">
                                    <option value="16">16-bit</option>
                                    <option value="24" selected>24-bit (Professional)</option>
                                    <option value="32">32-bit</option>
                                </select>
                            </div>
                            <div>
                                <label class="flex items-center">
                                    <input type="checkbox" checked class="mr-2">
                                    <span class="text-sm">Apply Professional Mastering</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="space-y-6">
                <!-- Generated Audio -->
                <div class="glass-dark rounded-xl p-6">
                    <h2 class="text-xl font-semibold mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path>
                        </svg>
                        Generated Audio
                    </h2>
                    
                    <div id="generated-audio" class="hidden">
                        <div class="bg-purple-900/30 rounded-lg p-4 mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <span id="audio-filename" class="font-semibold">test.mid</span>
                                <div class="flex space-x-2">
                                    <button id="copy-btn" class="p-2 bg-gray-700 rounded-lg hover:bg-gray-600 transition-colors">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                        </svg>
                                    </button>
                                    <button id="download-btn" class="p-2 bg-gray-700 rounded-lg hover:bg-gray-600 transition-colors">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div class="text-sm text-gray-400 mb-3">
                                <span id="audio-duration">2.00s</span> • <span id="audio-quality">professional quality</span>
                            </div>
                            <div class="mb-4">
                                <audio id="audio-player" controls class="w-full bg-gray-800 rounded">
                                    <source src="" type="audio/wav">
                                    Your browser does not support the audio element.
                                </audio>
                            </div>
                            <div class="audio-waveform mb-4"></div>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <div class="bg-gray-800/50 rounded p-2">
                                    <div class="font-semibold">Format:</div>
                                    <div id="audio-format">WAV</div>
                                </div>
                                <div class="bg-gray-800/50 rounded p-2">
                                    <div class="font-semibold">Bit Depth:</div>
                                    <div id="audio-bitdepth">24-bit</div>
                                </div>
                                <div class="bg-gray-800/50 rounded p-2">
                                    <div class="font-semibold">Mastering:</div>
                                    <div id="audio-mastering">Applied</div>
                                </div>
                                <div class="bg-gray-800/50 rounded p-2">
                                    <div class="font-semibold">Quality:</div>
                                    <div id="audio-quality-level">Professional</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="loading-audio" class="hidden text-center py-8">
                        <div class="loading-spinner mx-auto mb-4 loading-animation"></div>
                        <p class="text-gray-400 loading-animation">Generating high-quality audio...</p>
                        <p class="text-sm text-gray-500 mt-2 loading-animation">Processing MIDI and synthesizing cello sounds</p>
                    </div>
                    
                    <div id="no-audio" class="text-center py-8 text-gray-400">
                        <svg class="w-12 h-12 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                        </svg>
                        <p>Upload a MIDI file to generate audio</p>
                    </div>
                </div>

                <!-- Training Status -->
                <div class="glass-dark rounded-xl p-6">
                    <h2 class="text-xl font-semibold mb-4">Training Status</h2>
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between text-sm mb-2">
                                <span>Progress</span>
                                <span id="training-progress">0%</span>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-2">
                                <div id="progress-bar" class="bg-gradient-to-r from-purple-500 to-blue-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="text-sm">
                            <span class="text-gray-400">Status:</span>
                            <span id="training-status" class="ml-2">Idle</span>
                        </div>
                        
            <!-- Training Details -->
            <div id="training-details" class="mt-4 p-3 bg-gray-800/50 rounded-lg text-sm">
                <div class="text-gray-400">Training details will appear here...</div>
            </div>
            
            <!-- Model Status -->
            <div id="model-status" class="mt-4 p-3 bg-blue-900/20 rounded-lg border border-blue-500/30">
                <h4 class="text-blue-400 font-semibold mb-2">Model Status</h4>
                <div id="model-info" class="text-sm">
                    <div class="mb-2">
                        <span class="text-gray-400">TensorFlow:</span>
                        <span id="tensorflow-status" class="ml-2 text-yellow-400">Checking...</span>
                    </div>
                    <div class="mb-2">
                        <span class="text-gray-400">Google DDSP:</span>
                        <span id="ddsp-status" class="ml-2 text-yellow-400">Checking...</span>
                    </div>
                    <div class="mb-2">
                        <span class="text-gray-400">Synthesis Mode:</span>
                        <span id="synthesis-mode" class="ml-2 text-yellow-400">Checking...</span>
                    </div>
                    <div id="ddsp-explanation" class="mt-3 text-xs text-gray-500 hidden">
                        <div class="bg-yellow-900/20 p-2 rounded border border-yellow-500/30">
                            <strong>Why Google DDSP is not available:</strong><br>
                            Google DDSP requires numba and llvmlite libraries which need CMake to compile.<br>
                            The system automatically falls back to Enhanced Custom Synthesis which provides<br>
                            professional-quality audio with 4-harmonic cello modeling and clean ADSR envelopes.
                        </div>
                    </div>
                </div>
            </div>
                        
                        <!-- Model Selector -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Select Trained Model</label>
                            <select id="model-selector" class="w-full bg-gray-800 text-white border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:border-blue-500">
                                <option value="">Loading models...</option>
                            </select>
                            <p class="text-xs text-gray-400 mt-1">Trained models learned from 1276 cello samples</p>
                        </div>
                        
                        <!-- Training Results -->
                        <div id="training-results" class="mt-4"></div>
                        <button id="train-btn" class="btn-primary px-6 py-3 rounded-lg font-semibold w-full">
                            Train Model
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DDSP Neural Cello - Frontend JavaScript
        // embracingearth.space - Premium AI Audio Synthesis
        
        const API_BASE = 'http://localhost:8000';
        
        // Load available models on page load
        function loadAvailableModels() {
            fetch(`${API_BASE}/health`)
                .then(response => response.json())
                .then(data => {
                    const modelSelector = document.getElementById('model-selector');
                    modelSelector.innerHTML = '';
                    
                    if (data.available_models && data.available_models.length > 0) {
                        data.available_models.forEach(model => {
                            const option = document.createElement('option');
                            option.value = model.name;
                            option.textContent = `${model.name} (${(model.size / 1024).toFixed(1)} KB)`;
                            if (model.is_loaded) {
                                option.textContent += ' [LOADED]';
                            }
                            modelSelector.appendChild(option);
                        });
                        
                        // Select current model if available
                        if (data.current_model) {
                            modelSelector.value = data.current_model;
                        }
                    } else {
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = 'No trained models available';
                        modelSelector.appendChild(option);
                    }
                })
                .catch(error => {
                    console.error('Failed to load models:', error);
                    const modelSelector = document.getElementById('model-selector');
                    modelSelector.innerHTML = '<option value="">Error loading models</option>';
                });
        }
        
        // Load models when page loads
        loadAvailableModels();
        let selectedQuality = 'professional';
        let currentAudioFile = null;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            updateTrainingStatus();
            updateModelStatus(); // Add model status check
        });
        
        function initializeEventListeners() {
            // File upload
            const uploadArea = document.getElementById('upload-area');
            const fileInput = document.getElementById('file-input');
            
            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('drop', handleDrop);
            fileInput.addEventListener('change', handleFileSelect);
            
            // Quality selection
            document.querySelectorAll('.quality-option').forEach(option => {
                option.addEventListener('click', () => selectQuality(option.dataset.quality));
            });
            
            // Settings button
            document.getElementById('settings-btn').addEventListener('click', toggleSettings);
            
            // Train button
            document.getElementById('train-btn').addEventListener('click', startTraining);
            
            // Audio buttons
            document.getElementById('download-btn').addEventListener('click', downloadAudio);
            document.getElementById('copy-btn').addEventListener('click', copyAudioInfo);
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('border-purple-300');
        }
        
        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('border-purple-300');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }
        
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }
        
        function handleFile(file) {
            if (!file.name.toLowerCase().match(/\.(mid|midi)$/)) {
                alert('Please select a MIDI file (.mid or .midi)');
                return;
            }
            
            // Show file info
            document.getElementById('file-name').textContent = file.name;
            document.getElementById('file-info').classList.remove('hidden');
            
            // Upload file
            uploadMIDI(file);
        }
        
        function uploadMIDI(file) {
            const formData = new FormData();
            formData.append('file', file);
            
            // Show loading
            document.getElementById('loading-audio').classList.remove('hidden');
            document.getElementById('generated-audio').classList.add('hidden');
            document.getElementById('no-audio').classList.add('hidden');
            
            // Add timeout and better error handling
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
            
            fetch(`${API_BASE}/api/upload-midi`, {
                method: 'POST',
                body: formData,
                signal: controller.signal
            })
            .then(response => {
                clearTimeout(timeoutId);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Upload response:', data);
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Show generated audio
                showGeneratedAudio(data);
            })
            .catch(error => {
                clearTimeout(timeoutId);
                console.error('Upload error:', error);
                
                // Show error message
                document.getElementById('loading-audio').classList.add('hidden');
                document.getElementById('generated-audio').classList.add('hidden');
                document.getElementById('no-audio').classList.remove('hidden');
                
                // Update no-audio message to show error
                const noAudioDiv = document.getElementById('no-audio');
                noAudioDiv.innerHTML = `
                    <svg class="w-12 h-12 mx-auto mb-4 opacity-50 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <p class="text-red-400">Upload failed: ${error.message}</p>
                    <p class="text-sm text-gray-400 mt-2">Try uploading a different MIDI file</p>
                `;
            });
        }
        
        function showGeneratedAudio(data) {
            document.getElementById('loading-audio').classList.add('hidden');
            document.getElementById('generated-audio').classList.remove('hidden');
            
            // Update audio info with enhanced formatting
            const filename = data.original_filename || data.filename || 'Generated Audio';
            const duration = data.duration ? data.duration.toFixed(2) : '2.00';
            const quality = data.quality_level || data.quality || 'professional';
            
            document.getElementById('audio-filename').textContent = filename;
            document.getElementById('audio-duration').textContent = `${duration}s • ${quality} quality`;
            document.getElementById('audio-quality').textContent = quality;
            document.getElementById('audio-format').textContent = data.format || 'WAV';
            document.getElementById('audio-bitdepth').textContent = data.bit_depth + '-bit';
            document.getElementById('audio-mastering').textContent = data.mastering_applied ? 'Applied' : 'None';
            document.getElementById('audio-quality-level').textContent = data.quality || 'Professional';
            
            // Store download URL - use output_file from server response
            const outputFile = data.output_file || data.filename;
            currentAudioFile = outputFile;
            
            // Extract filename from path for display
            const displayName = outputFile.split('/').pop() || outputFile.split('\\').pop() || 'Generated Audio';
            
            const downloadUrl = `${API_BASE}/api/download/${outputFile}`;
            
            // Update audio player with actual audio
            const audioPlayer = document.getElementById('audio-player');
            if (audioPlayer) {
                audioPlayer.src = downloadUrl;
            }
            
            // Update download button functionality
            const downloadBtn = document.getElementById('download-btn');
            if (downloadBtn) {
                downloadBtn.onclick = function() {
                    const link = document.createElement('a');
                    link.href = downloadUrl;
                    link.download = displayName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                };
            }
            
            // Add visual feedback with animation
            const generatedCard = document.getElementById('generated-audio');
            generatedCard.style.animation = 'fadeInUp 0.5s ease-out';
            
            // Show success message with details
            console.log('Audio generated successfully:', data);
            
            // Add copy to clipboard functionality
            const copyButton = document.getElementById('copy-details');
            if (copyButton) {
                copyButton.onclick = () => {
                    const details = `Generated Audio: ${filename}\nDuration: ${duration}s\nQuality: ${quality}\nFormat: ${data.format || 'WAV'}\nBit Depth: ${data.bit_depth}-bit\nMastering: ${data.mastering_applied ? 'Applied' : 'None'}`;
                    navigator.clipboard.writeText(details).then(() => {
                        // Show copy success feedback
                        copyButton.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
                        setTimeout(() => {
                            copyButton.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>';
                        }, 2000);
                    });
                };
            }
        }
        
        function showNoAudio() {
            document.getElementById('loading-audio').classList.add('hidden');
            document.getElementById('generated-audio').classList.add('hidden');
            document.getElementById('no-audio').classList.remove('hidden');
        }
        
        function selectQuality(quality) {
            selectedQuality = quality;
            document.querySelectorAll('.quality-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelector(`[data-quality="${quality}"]`).classList.add('selected');
        }
        
        function toggleSettings() {
            const panel = document.getElementById('settings-panel');
            const btn = document.getElementById('settings-btn');
            
            if (panel.classList.contains('hidden')) {
                panel.classList.remove('hidden');
                btn.textContent = 'Close Settings';
            } else {
                panel.classList.add('hidden');
                btn.textContent = 'Open Settings';
            }
        }
        
        function startTraining() {
            const btn = document.getElementById('train-btn');
            btn.disabled = true;
            btn.textContent = 'Training...';
            
            fetch(`${API_BASE}/api/training/start`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                console.log('Training started:', data);
                updateTrainingStatus();
            })
            .catch(error => {
                console.error('Training error:', error);
                alert('Training failed: ' + error.message);
                btn.disabled = false;
                btn.textContent = 'Train Model';
            });
        }
        
        function updateTrainingStatus() {
            fetch(`${API_BASE}/api/training/status`)
            .then(response => response.json())
            .then(data => {
                console.log('Training status:', data);
                
                const progress = Math.round(data.progress * 100);
                document.getElementById('training-progress').textContent = progress + '%';
                document.getElementById('progress-bar').style.width = progress + '%';
                document.getElementById('training-status').textContent = data.status || 'Unknown';
                
                // Update detailed training information
                updateTrainingDetails(data);
                
                const btn = document.getElementById('train-btn');
                if (data.status === 'completed') {
                    btn.disabled = false;
                    btn.textContent = 'Training Complete';
                    showTrainingResults(data);
                } else if (data.status === 'failed') {
                    btn.disabled = false;
                    btn.textContent = 'Training Failed';
                } else if (data.status === 'idle') {
                    btn.disabled = false;
                    btn.textContent = 'Train Model';
                } else {
                    btn.disabled = true;
                    btn.textContent = 'Training...';
                }
                
                // Continue polling if training is in progress
                if (data.status === 'loading' || data.status === 'processing' || data.status === 'training') {
                    setTimeout(updateTrainingStatus, 1000);
                }
            })
            .catch(error => {
                console.error('Status error:', error);
            });
        }
        
        function updateTrainingDetails(data) {
            const detailsContainer = document.getElementById('training-details');
            if (!detailsContainer) return;
            
            let detailsHTML = '';
            
            // Show current phase
            if (data.status) {
                detailsHTML += `<div class="mb-2"><strong>Phase:</strong> ${data.status}</div>`;
            }
            
            // Show method and algorithm
            if (data.method) {
                detailsHTML += `<div class="mb-2"><strong>Method:</strong> ${data.method}</div>`;
            }
            if (data.algorithm) {
                detailsHTML += `<div class="mb-2"><strong>Algorithm:</strong> ${data.algorithm}</div>`;
            }
            
            // Show training progress
            if (data.epoch && data.total_epochs) {
                detailsHTML += `<div class="mb-2"><strong>Epoch:</strong> ${data.epoch}/${data.total_epochs}</div>`;
            }
            if (data.loss !== undefined) {
                detailsHTML += `<div class="mb-2"><strong>Loss:</strong> ${data.loss}</div>`;
            }
            if (data.accuracy !== undefined) {
                detailsHTML += `<div class="mb-2"><strong>Accuracy:</strong> ${(data.accuracy * 100).toFixed(1)}%</div>`;
            }
            
            // Show samples loaded
            if (data.samples_loaded !== undefined && data.total_samples) {
                detailsHTML += `<div class="mb-2"><strong>Samples:</strong> ${data.samples_loaded}/${data.total_samples}</div>`;
            }
            
            // Show architecture details
            if (data.architecture) {
                detailsHTML += `<div class="mb-2"><strong>Architecture:</strong> ${data.architecture.layers} layers, ${data.architecture.neurons_per_layer} neurons</div>`;
            }
            
            detailsContainer.innerHTML = detailsHTML;
        }
        
        function updateModelStatus() {
            fetch(`${API_BASE}/health`)
            .then(response => response.json())
            .then(data => {
                console.log('Model status:', data);
                
                // Update TensorFlow status
                const tfStatus = document.getElementById('tensorflow-status');
                if (data.tensorflow_available) {
                    tfStatus.textContent = 'Available';
                    tfStatus.className = 'ml-2 text-green-400';
                } else {
                    tfStatus.textContent = 'Not Available';
                    tfStatus.className = 'ml-2 text-red-400';
                }
                
                // Update Google DDSP status
                const ddspStatus = document.getElementById('ddsp-status');
                if (data.ddsp_available) {
                    ddspStatus.textContent = 'Available';
                    ddspStatus.className = 'ml-2 text-green-400';
                } else {
                    ddspStatus.textContent = 'Not Available (Fallback Mode)';
                    ddspStatus.className = 'ml-2 text-yellow-400';
                }
                
                // Update synthesis mode
                const synthesisMode = document.getElementById('synthesis-mode');
                synthesisMode.textContent = data.synthesis_mode || 'Unknown';
                if (data.synthesis_mode === 'Google DDSP') {
                    synthesisMode.className = 'ml-2 text-green-400';
                } else {
                    synthesisMode.className = 'ml-2 text-blue-400';
                }
                
                // Show explanation if Google DDSP is not available
                const explanation = document.getElementById('ddsp-explanation');
                if (!data.ddsp_available) {
                    explanation.classList.remove('hidden');
                } else {
                    explanation.classList.add('hidden');
                }
            })
            .catch(error => {
                console.error('Model status error:', error);
            });
        }
        
        function showTrainingResults(data) {
            const resultsContainer = document.getElementById('training-results');
            if (!resultsContainer) return;
            
            let resultsHTML = '<div class="mt-4 p-4 bg-green-900/20 rounded-lg border border-green-500/30">';
            resultsHTML += '<h4 class="text-green-400 font-semibold mb-3">Training Results</h4>';
            
            if (data.method) {
                resultsHTML += `<div class="mb-2"><strong>Method:</strong> ${data.method}</div>`;
            }
            if (data.algorithm) {
                resultsHTML += `<div class="mb-2"><strong>Algorithm:</strong> ${data.algorithm}</div>`;
            }
            if (data.training_time) {
                resultsHTML += `<div class="mb-2"><strong>Training Time:</strong> ${data.training_time}</div>`;
            }
            if (data.total_samples) {
                resultsHTML += `<div class="mb-2"><strong>Total Samples:</strong> ${data.total_samples}</div>`;
            }
            
            if (data.performance) {
                resultsHTML += '<div class="mt-3"><strong>Performance:</strong></div>';
                if (data.performance.final_loss !== undefined) {
                    resultsHTML += `<div class="ml-4">Final Loss: ${data.performance.final_loss}</div>`;
                }
                if (data.performance.final_accuracy !== undefined) {
                    resultsHTML += `<div class="ml-4">Final Accuracy: ${(data.performance.final_accuracy * 100).toFixed(1)}%</div>`;
                }
                if (data.performance.f1_score !== undefined) {
                    resultsHTML += `<div class="ml-4">F1 Score: ${data.performance.f1_score}</div>`;
                }
            }
            
            if (data.architecture) {
                resultsHTML += '<div class="mt-3"><strong>Architecture:</strong></div>';
                if (data.architecture.layers) {
                    resultsHTML += `<div class="ml-4">Layers: ${data.architecture.layers}</div>`;
                }
                if (data.architecture.neurons_per_layer) {
                    resultsHTML += `<div class="ml-4">Neurons per Layer: ${data.architecture.neurons_per_layer}</div>`;
                }
                if (data.architecture.total_parameters) {
                    resultsHTML += `<div class="ml-4">Total Parameters: ${data.architecture.total_parameters.toLocaleString()}</div>`;
                }
                if (data.architecture.model_size) {
                    resultsHTML += `<div class="ml-4">Model Size: ${data.architecture.model_size}</div>`;
                }
                if (data.architecture.google_ddsp_enabled !== undefined) {
                    resultsHTML += `<div class="ml-4">Google DDSP: ${data.architecture.google_ddsp_enabled ? 'Enabled' : 'Fallback Mode'}</div>`;
                }
                if (data.architecture.tensorflow_version) {
                    resultsHTML += `<div class="ml-4">TensorFlow Version: ${data.architecture.tensorflow_version}</div>`;
                }
            }
            
            if (data.google_ddsp_status) {
                resultsHTML += '<div class="mt-3"><strong>Google DDSP Status:</strong></div>';
                resultsHTML += `<div class="ml-4">${data.google_ddsp_status}</div>`;
            }
            
            if (data.audio_quality) {
                resultsHTML += '<div class="mt-3"><strong>Audio Quality:</strong></div>';
                if (data.audio_quality.sample_rate) {
                    resultsHTML += `<div class="ml-4">Sample Rate: ${data.audio_quality.sample_rate}Hz</div>`;
                }
                if (data.audio_quality.bit_depth) {
                    resultsHTML += `<div class="ml-4">Bit Depth: ${data.audio_quality.bit_depth}-bit</div>`;
                }
                if (data.audio_quality.dynamic_range) {
                    resultsHTML += `<div class="ml-4">Dynamic Range: ${data.audio_quality.dynamic_range}</div>`;
                }
                if (data.audio_quality.thd) {
                    resultsHTML += `<div class="ml-4">THD: ${data.audio_quality.thd}</div>`;
                }
            }
            
            resultsHTML += '</div>';
            resultsContainer.innerHTML = resultsHTML;
        }
        
        function downloadAudio() {
            if (!currentAudioFile) {
                alert('No audio file to download');
                return;
            }
            
            const filename = currentAudioFile.split('/').pop();
            const downloadUrl = `${API_BASE}/api/download/${filename}`;
            
            // Create temporary link and click it
            const link = document.createElement('a');
            link.href = downloadUrl;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function copyAudioInfo() {
            const info = {
                filename: document.getElementById('audio-filename').textContent,
                duration: document.getElementById('audio-duration').textContent,
                quality: document.getElementById('audio-quality').textContent,
                format: document.getElementById('audio-format').textContent,
                bitDepth: document.getElementById('audio-bitdepth').textContent,
                mastering: document.getElementById('audio-mastering').textContent
            };
            
            const text = `Generated Audio: ${info.filename}\nDuration: ${info.duration}\nQuality: ${info.quality}\nFormat: ${info.format}\nBit Depth: ${info.bitDepth}\nMastering: ${info.mastering}`;
            
            navigator.clipboard.writeText(text).then(() => {
                alert('Audio info copied to clipboard!');
            }).catch(() => {
                alert('Failed to copy to clipboard');
            });
        }
    </script>
</body>
</html>
